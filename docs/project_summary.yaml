board:
  name: Waveshare ESP32-S3 Touch AMOLED 2.41
  mcu: ESP32-S3
  flash: 16MB
  psram: 8MB
  display_controller: RM690B0
  display_interface: QSPI (32-bit command mode)
  display_resolution: 600x450
  circuitpython_version: 10.0.3

pins:
  display_qspi:
    cs: GPIO9
    sck: GPIO10
    d0: GPIO11
    d1: GPIO12
    d2: GPIO13
    d3: GPIO14
    reset: GPIO21
  power:
    display_power: GPIO16 # Critical for display operation
    battery_control: GPIO16
    battery_key: GPIO15
  i2c:
    sda: GPIO47
    scl: GPIO48
  spi_sd:
    cs: GPIO2
    sck: GPIO4
    mosi: GPIO5
    miso: GPIO6
  touch:
    sda: GPIO47 # Shared with I2C
    scl: GPIO48 # Shared with I2C
    reset: GPIO3
    interrupt: EXIO2
  other:
    battery_adc: GPIO17
    uart_tx: GPIO43
    uart_rx: GPIO44
    boot_button: GPIO0

i2c_devices:
  - { name: Touch FT6336U, addr: 0x38, status: working }
  - { name: RTC PCF85063, addr: 0x51, status: working }
  - { name: IMU QMI8658C, addr: 0x6B, status: working }
  - { name: IO Expander PCA9554, addr: 0x20, status: working }

current_status:
  display_driver: Production-ready for standalone rendering with native text support (rm690b0)
  native_text: âœ… COMPLETE - 7 built-in bitmap fonts (8x8 to 32x48), set_font(id) + text(x,y,str,color,bg) API, TTF conversion toolchain
  lvgl_integration: Feature-complete, but NOT production-ready â€“ known critical bug: LVGL + touch can become unresponsive under GC pressure (frequent gc.collect() / large heap allocations like TTF)
  sd_card: âœ… SOLVED - espsdcard module provides reliable SD card access using native ESP-IDF drivers
  esp_modules: espnow enabled, espcamera disabled, espulp available, espidf enabled, espsdcard enabled
  next_milestone: Phase 6 - Documentation, Stability & Widget Library Expansion (Slider, Checkbox, Switch, etc.)

major_task:
  goal: Expand Python widget library and create comprehensive documentation for both rm690b0 and rm690b0_lvgl modules.
  current_state: LVGL v8.x fully integrated with Python widget API (Widget, Label, Button). Display driver renders at 100+ FPS with native text support (7 built-in fonts), touch input working with coordinate transformation, event system with Python callbacks functional.
  approach: Create Getting Started guides for rm690b0 and rm690b0_lvgl modules, build widget gallery example, implement additional widgets (Slider, Checkbox, Switch, Arc, Bar, Image, Textarea, Dropdown, Roller) following existing pattern. Native text rendering complete with TTF conversion toolchain.

implementation_plan_summary:
  - âœ… ESP-IDF vendor panel (`esp_lcd_rm690b0.c`) mirrored into the board support package with QSPI command wrapping and MADCTL handling.
  - âœ… `common-hal/rm690b0` driver allocates DMA-safe frame buffers with double-buffering support, proxies `esp_lcd_panel_draw_bitmap`, and exposes fill/line/rect primitives plus rotation and brightness control.
  - âœ… `shared-bindings/rm690b0` module surfaces the Python API for drawing primitives, rotation, and brightness control.
  - âœ… SD card support: Native `espsdcard` module provides reliable 645 KB/s reads with pre-allocated buffers, solving all previous sdcardio stability issues.
  - âœ… LVGL v8.x library compiled and integrated into CircuitPython firmware.
  - âœ… LVGL display driver with flush callback using existing RM690B0 DMA paths, rendering at 100+ FPS with zero artifacts.
  - âœ… LVGL touch input driver with automatic portraitâ†’landscape coordinate transformation for FT6336U.
  - âœ… Python widget API created: Widget (base), Label (text display), Button (clickable with callbacks).
  - âœ… Event system with Python callbacks for button clicks and widget interactions.
  - âœ… Property system with MP_TYPE_FLAG_HAS_SPECIAL_ACCESSORS for read/write properties (x, y, width, height).
  - âœ… Widget inheritance system: Label and Button inherit Widget properties correctly.
  - âœ… Interactive GUI examples tested on hardware (counter app, multi-button controls, settings panels).
  - âœ… Build system integration: All widget files added to circuitpy_defns.mk (SRC_BINDINGS_ENUMS and SRC_COMMON_HAL_ALL).
  - ðŸš§ Phase 6 Tasks: Create Getting Started guides, expand widget library with 9-13 additional widgets (Slider, Checkbox, Switch, Arc, Bar, Image, Textarea, Dropdown, Roller, Panel, Tabview, Spinner, Chart).

issues_solved:
  - { name: 32-bit QSPI command framing, id: qspi_cmd_width, solution: Uses `esp_lcd_panel_io_spi` with `lcd_cmd_bits=32` and quad mode }
  - { name: Initialization timing, id: init_sequence, solution: Ported proven RM690B0 command table with per-step delays }
  - { name: Column/row offsets, id: address_windows, solution: Adds configurable X/Y gap tracking inside the panel driver }
  - { name: BGR color swap, id: color_swap, solution: Adjusts MADCTL and swaps green/blue channels before transfers }
  - { name: Even-pixel DMA requirement, id: dma_alignment, solution: PSRAM framebuffer with aligned flushes preserves odd-pixel updates while satisfying DMA }
  - { name: Sparse line rendering artifacts, id: padding_artifacts, solution: Modified vertical and horizontal padding to read from framebuffer at expanded coordinates instead of duplicating edge pixels }
  - { name: Right edge artifacts, id: bounds_checking, solution: Added bounds checking to horizontal padding loops to prevent out-of-bounds framebuffer access }
  - { name: Hardware timing artifacts, id: timing_delay, solution: Implemented adaptive delay formula (pixels_transferred / 36, minimum 50Âµs) that scales with transfer size to prevent color mixing }

working_features:
  rm690b0_module:
    - RM690B0 driver constructs successfully and toggles reset/power GPIOs.
    - `init_display()` issues the full RM690B0 command table and exits sleep.
    - Drawing helpers (`fill_color`, `fill_rect`, `hline`, `vline`, `pixel`, `line`, `circle`, `fill_circle`, `rect`) render via DMA-backed QSPI transfers.
    - Module exposes RGB565 convenience constants (`BLACK`, `WHITE`, `RED`, `GREEN`, `BLUE`, `YELLOW`, `MAGENTA`, `CYAN`, `ORANGE`, `GRAY`) for quick sketching.
    - Software coordinate remap keeps 0/90/180/270 rotations working without relying on panel-specific MADCTL quirks.
    - Brightness API (`set_brightness`, `get_brightness`, and the `brightness` property) drives WRDISBV/WRCTRLD and caches the active level for reads.
    - API now exposes runtime getters for rotation, size, and brightness, enabling external validation scripts without baked-in tests.
    - PSRAM-backed framebuffer mirrors the panel so odd-pixel drawing and bitmap uploads preserve neighbours while still aligning DMA writes.
    - Single-pixel precision rendering at any coordinate (odd or even) without artifacts.
    - Image conversion supports BMP and JPEG formats; JPEG decoding on ESP32-S3 uses ESP-IDF's hardware-accelerated `esp_jpeg` decoder.
    - Double-buffering with `swap_buffers()` enables flicker-free updates and smooth animations.
    - Adaptive hardware timing delay ensures clean rendering at all operation sizes (50Âµs for small operations, 500Âµs for large bitmaps).
    - Native text rendering: `set_font(id)` selects from 7 built-in fonts (0=8x8, 1=16x16, 2=16x24, 3=24x24, 4=24x32, 5=32x32, 6=32x48).
    - Text API: `text(x, y, str, color, background)` draws UTF-8 text with transparent (background=None) or solid background.
    - 7 embedded bitmap fonts totaling ~538 KB in flash; ASCII 0x20-0x7E (95 characters); row-based format (MSB-first horizontal).
    - Font sources: Liberation Sans 16x16, Liberation Mono Bold 16x24, plus 8x8/24x24/24x32/32x32/32x48 variants.
    - Text rendering performance: 0.3-7.7 ms for "Hello World" depending on font size (10-500Ã— faster than DisplayIO).
    - TTF conversion toolchain: `ttf_to_rm690b0.py` converts any TrueType font to bitmap, `test_converted_font.py` validates/previews.
    - Independent from LVGL: native text works standalone for lightweight labels, debug output, status displays.
  rm690b0_lvgl_module:
    - LVGL v8.x library fully compiled and integrated.
    - Display driver renders at 100+ FPS with zero tearing or artifacts.
    - Touch input driver with automatic portraitâ†’landscape coordinate transformation.
    - Python widget classes: Widget (base container), Label (text display), Button (clickable button).
    - Full property support: x, y, width, height (read/write on all widgets).
    - Label properties: text (read/write), set_text_color() method.
    - Button properties: text (read/write), on_click (callback function).
    - Widget methods: set_style_bg_color(), set_style_bg_opa().
    - Event system: Python callbacks execute on button clicks.
    - Widget inheritance: Label and Button inherit all Widget properties and methods.
    - Memory efficient: 72 KB for LVGL display buffers, ~150-600 bytes per widget.
    - Interactive GUI examples working: counter app, multi-button controls, settings panels.
    - Build system: All files compiled and linked (Widget.c, Label.c, Button.c, RM690B0_LVGL.c).

limitations:
  - Widget library currently limited to 3 widgets (Widget, Label, Button); 9-13 additional widgets planned for Phase 6.
  - No Getting Started guides yet; documentation in progress.
  - `board.DISPLAY` auto-initialization not implemented (manual initialization required).
  - `blit_buffer()` assumes RGB565 sources; developers must pre-convert assets (the new JPEG loader handles this only on ESP32 when explicitly invoked).
  - JPEG decode depends on ESP-IDF's `esp_jpeg` decoder; non-ESP builds currently return `IMG_ERR_UNSUPPORTED`.
  - Adaptive delay adds minimum 50Âµs overhead per operation (acceptable for most use cases).
  - LVGL + touch stability under GC pressure: frequent `gc.collect()` in the UI loop or heavy heap allocations (e.g. TTF fonts) can cause touch/LVGL to stop responding; known bug in the current port. Workaround: avoid explicit `gc.collect()` in the main loop and load large assets early.
  - Native text: Fixed-width fonts only (no proportional spacing), no text measurement API yet, no word wrap, ASCII 0x20-0x7E only (extended Unicode planned).

next_steps:
  phase_6_priority_1_documentation:
    - Create comprehensive Getting Started guide for rm690b0 module (3-4 days).
    - Create comprehensive Getting Started guide for rm690b0_lvgl module (3-4 days).
    - Build widget gallery example showcasing all current widgets (2-3 days).
    - Create UI patterns library with common design patterns (2-3 days).
    - Update API reference documentation with complete property and method details (1-2 days).
    - Timeline: 1-2 weeks total.
  phase_6_priority_2_widget_expansion:
    - Tier 1 (Week 1): Slider, Checkbox, Switch, Arc (2-4 hours each).
    - Tier 2 (Week 2): Bar, Image (2-5 hours each).
    - Tier 3 (Week 3-4): Textarea, Dropdown, Roller (4-6 hours each).
    - Tier 4 (Future): Panel/Container, Tabview.
    - Tier 5 (Future): Spinner, Chart.
    - Timeline: 2-4 weeks total.
  other_priorities:
    - Create comprehensive test suite for BMP and JPEG image conversion with SD card integration (1 week).
    - Validate `esp_jpeg` decode path performance and add regression coverage for ESP-IDF component availability.
    - Profile BMP conversion for further optimization (line caching, DMA-assisted copies, output caching for static assets).
    - Board auto-initialization: board.DISPLAY, board.LVGL, board.TOUCH objects (optional, deferred).

test_suite_features:
  - Diagnostic helpers were removed from the Python API; future validation should rely on LVGL widget/scene tests that exercise the flush driver.
  - `ports/espressif/common-hal/rm690b0/tests/pattern_check.py` exercises single-pixel lines, sparse rows, and edge columns to verify framebuffer flush alignment.
  - `test_scripts/quick_test.py` provides 2-minute verification of adaptive delay implementation with performance benchmarks and visual artifact checks.
  - `test_scripts/test_adaptive_delay.py` offers comprehensive 10-minute test suite covering all operation sizes, performance comparisons, and stress tests.
  - Test scripts are CircuitPython-compatible and use time.monotonic() for timing measurements.

required_libraries:
  - rm690b0 (built-in module - standalone display driver)
  - rm690b0_lvgl (built-in module - LVGL integration with Python widget API)

key_files:
  board_definition: ports/espressif/boards/waveshare_esp32s3_amoled_241/
  panel_driver: ports/espressif/boards/waveshare_esp32s3_amoled_241/esp_lcd_rm690b0.c
  common_hal_driver: ports/espressif/common-hal/rm690b0/RM690B0.c
  python_bindings: shared-bindings/rm690b0/RM690B0.c
  test_scripts: test_scripts/
  documentation_root: docs/
  display_driver_plan:
  lvgl_guide: docs/RM690B0_LVGL.md
  project_summary: docs/project_summary.yaml
  project_status: docs/project_status_summary.md
  next_steps:
  technical_notes: docs/TECHNICAL_NOTES.md
  doc_update_summary:
  brief_artifact: knowledge/circuitpython/briefs/rm690b0_lvgl.md
  diff_tracker: knowledge/circuitpython/diffs/diff-main-rm690b0.diff
  font_docs: fonts/TTF_CONVERTER_README.md, fonts/QUICK_START_TTF.md, fonts/TTF_CONVERTER_SUMMARY.md
  font_tools: fonts/ttf_to_rm690b0.py, fonts/test_converted_font.py, fonts/example_ttf_conversion.sh

notes:
  - RM690B0 expects quad-SPI transactions at 80â€¯MHz with 32-bit opcodes; command and data phases are strictly separated.
  - MADCTL manipulation must keep the vendor-provided base value before toggling axis bits to avoid unintended mirroring.
  - DMA buffers allocated via `heap_caps_malloc(..., MALLOC_CAP_DMA)` should be released on deinit to avoid PSRAM fragmentation.
  - Driver handles brightness writes by selecting page 0, updating WRDISBV (0x51), and asserting WRCTRLD (0x53) with BCTRL/BL/DD bits.
  - Direct framebuffer flushes now stream the exact dirty rectangle; hardware even-alignment quirks are handled internally by the LCD driver.
  - Framebuffer lives in PSRAM; dirty regions are copied into a DMA-capable staging buffer before issuing `esp_lcd_panel_draw_bitmap`.
  - Adaptive delay formula: delay_us = pixels_transferred / 36 (minimum 50Âµs) ensures hardware has time to process transfers without unnecessary waiting.
  - Small operations (single lines): Use 50Âµs delay for optimal performance (10x faster than fixed 500Âµs).
  - Large operations (bitmaps): Automatically scale to 500Âµs delays for proper hardware processing.
  - Padding logic reads from framebuffer at expanded coordinates with bounds checking to prevent artifacts and out-of-bounds access.
  - LVGL integration complete: Display and touch drivers functional, Python widget API (Widget, Label, Button) working.
  - Widget property system uses MP_TYPE_FLAG_HAS_SPECIAL_ACCESSORS flag for proper MP_PROPERTY_GETSET support.
  - Widget inheritance: Label and Button explicitly include Widget properties in locals_dict for proper inheritance.
  - Build system: Widget files added to both SRC_BINDINGS_ENUMS and SRC_COMMON_HAL_ALL in py/circuitpy_defns.mk.
  - Performance: 100+ FPS rendering, ~72 KB LVGL buffers in PSRAM, ~150-600 bytes per widget.
  - Documentation consolidated: All LVGL docs merged into comprehensive docs/RM690B0_LVGL.md guide (1100+ lines).
  - Native text rendering: Section 11 in TECHNICAL_NOTES.md updated with complete architecture, API reference, font format, TTF conversion toolchain.
  - Font conversion toolchain: 3 documentation files (README, Quick Start, Summary) totaling ~1800 lines covering usage, examples, integration workflow.
  - snapshot.txt updated with native text API details: 7 fonts, conversion tools, memory usage, performance characteristics.
  - Phase 5 complete: LVGL integration with Python widget API + native text rendering fully functional and tested on hardware.
  - Phase 6 planned: Documentation (Getting Started guides) + Widget expansion (9-13 additional widgets).
